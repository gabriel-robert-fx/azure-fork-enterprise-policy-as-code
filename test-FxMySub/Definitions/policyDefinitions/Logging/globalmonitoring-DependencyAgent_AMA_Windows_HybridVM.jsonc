{
    "$schema": "https://raw.githubusercontent.com/Azure/enterprise-azure-policy-as-code/main/Schemas/policy-definition-schema.json",
    "name": "globalmonitoring-DependencyAgent_AMA_Windows_HybridVM",
    "properties": {
        // "displayName": "Configure Dependency agent on Azure Arc enabled Windows servers with Azure Monitoring Agent settings",
        "displayName": "globalmonitoring-DependencyAgent_AMA_Windows_HybridVM",
        "policyType": "Custom",
        "mode": "Indexed",
        "description": "Enable VM insights on servers and machines connected to Azure through Arc enabled servers by installing the Dependency agent virtual machine extension with Azure Monitoring Agent settings. VM insights uses the Dependency agent to collect network metrics and discovered data about processes running on the machine and external process dependencies. See more - https://aka.ms/vminsightsdocs.",
        "metadata": {
            "version": "1.1.2",
            "category": "Monitoring"
        },
        "parameters": {
            "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                },
                "allowedValues": [
                    "DeployIfNotExists",
                    "Disabled"
                ],
                "defaultValue": "DeployIfNotExists"
            },
            "monitoringTagName": {
                "type": "String",
                "defaultValue": "Ops:GlobalMonitoring",
                "metadata": {
                    "displayName": "Tag name for GlobalMonitoring",
                    "description": "Global Monitoring: resource to be monitored"
                }
            },
            "monitoringTagValue": {
                "type": "String",
                "defaultValue": "True",
                "metadata": {
                    "displayName": "Tag value for GlobalMonitoring Tag",
                    "description": "Global Monitoring: resource to be monitored"
                }
            },
            "enableProcessesAndDependencies": {
                "type": "Boolean",
                "metadata": {
                    "displayName": "Enable Processes and Dependencies",
                    "description": "This is the flag for enabling processes and dependencies data collection in VMInsights. If you are using this standalone policy and what to install Dependency Agent, keep this value as true."
                },
                "allowedValues": [
                    true,
                    false
                ],
                "defaultValue": true
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.HybridCompute/machines"
                    },
                    {
                        "value": "[parameters('enableProcessesAndDependencies')]",
                        "equals": true
                    },
                    {
                        "field": "tags",
                        "containsKey": "[parameters('monitoringTagName')]"
                      },
                      {
                        "field": "[concat( 'tags[', parameters('monitoringTagName'), ']' )]",
                        "equals": "[parameters('monitoringTagValue')]"
                      },
                    {
                        "field": "Microsoft.HybridCompute/machines/osName",
                        "equals": "windows"
                    }
                ]
            },
            "then": {
                "effect": "[parameters('effect')]",
                "details": {
                    "type": "Microsoft.HybridCompute/machines/extensions",
                    "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
                    ],
                    "existenceCondition": {
                        "allOf": [
                            {
                                "field": "Microsoft.HybridCompute/machines/extensions/type",
                                "equals": "DependencyAgentWindows"
                            },
                            {
                                "field": "Microsoft.HybridCompute/machines/extensions/publisher",
                                "equals": "Microsoft.Azure.Monitoring.DependencyAgent"
                            },
                            {
                                "field": "Microsoft.HybridCompute/machines/extensions/provisioningState",
                                "equals": "Succeeded"
                            }
                        ]
                    },
                    "deployment": {
                        "properties": {
                            "mode": "incremental",
                            "template": {
                                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                "contentVersion": "1.0.0.0",
                                "parameters": {
                                    "vmName": {
                                        "type": "string"
                                    },
                                    "location": {
                                        "type": "string"
                                    }
                                },
                                "variables": {
                                    "DaExtensionName": "DependencyAgentWindows",
                                    "DaExtensionType": "DependencyAgentWindows"
                                },
                                "resources": [
                                    {
                                        "type": "Microsoft.HybridCompute/machines/extensions",
                                        "apiVersion": "2020-03-11-preview",
                                        "name": "[concat(parameters('vmName'), '/', variables('DaExtensionName'))]",
                                        "location": "[parameters('location')]",
                                        "properties": {
                                            "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                                            "type": "[variables('DaExtensionType')]",
                                            "autoUpgradeMinorVersion": true,
                                            "settings": {
                                                "enableAMA": "true"
                                            }
                                        }
                                    }
                                ],
                                "outputs": {
                                    "policy": {
                                        "type": "string",
                                        "value": "[concat('Enabled DA extension for VM', ': ', parameters('vmName'))]"
                                    }
                                }
                            },
                            "parameters": {
                                "vmName": {
                                    "value": "[field('name')]"
                                },
                                "location": {
                                    "value": "[field('location')]"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}