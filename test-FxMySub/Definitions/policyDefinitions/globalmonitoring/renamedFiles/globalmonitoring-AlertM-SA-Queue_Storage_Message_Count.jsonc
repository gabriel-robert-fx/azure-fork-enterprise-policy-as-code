[
  {
    "$schema": "https://raw.githubusercontent.com/Azure/enterprise-azure-policy-as-code/main/Schemas/policy-definition-schema.json",
    "name": "globalmonitoring-AlertM-SA-Queue_Storage_Message_Count",
    "properties": {
      "displayName": "Alert Microsoft.Storage/storageAccounts/queueservices - Queue Storage Message Count",
      "description": "Create Queue Storage Message Count alerts for  resources",
      "metadata": {
        "category": "Alerts",
        "version": "1.0.0",
        "alertType": "Microsoft.Insights/metricAlerts",
        "targetResourceType": "Microsoft.Storage/storageAccounts/queueservices",
        "ruleName": "Queue Storage Message Count"
      },
      "parameters": {
        "effect": {
          "metadata": {
            "description": "Enable or disable the execution of the policy",
            "displayName": "Effect"
          },
          "type": "String",
          "defaultValue": "AuditIfNotExists",
          "allowedValues": [
            "AuditIfNotExists",
            "DeployIfNotExists",
            "Audit",
            "Disabled"
          ]
        },
        "actionGroupId": {
          "metadata": {
            "description": "The action group id to use when the alert is triggered",
            "displayName": "Action Group Id"
          },
          "type": "String"
        }
      },
      "policyRule": {
        "if": {
          "allOf": [
            {
              "equals": "Microsoft.Storage/storageAccounts/queueservices",
              "field": "type"
            },
            {
              "equals": "True",
              "field": "tags[\u0027Ops:GlobalMonitoring\u0027]"
            }
          ]
        },
        "then": {
          "effect": "[parameters(\u0027effect\u0027)]",
          "details": {
            "type": "Microsoft.Insights/metricAlerts",
            "existenceScope": "ResourceGroup",
            "name": "[concat(\u0027ar-\u0027, field(\u0027name\u0027), \u0027-Queue Storage Message Count\u0027)]",
            "evaluationDelay": "AfterProvisioningSuccess",
            "roleDefinitionIds": [
              "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
            ],
            "deploymentScope": "ResourceGroup",
            "deployment": {
              "properties": {
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "resourceId": {
                      "type": "string"
                    },
                    "resourceName": {
                      "type": "string"
                    },
                    "actionGroupId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "[concat(\u0027ar-\u0027, parameters(\u0027resourceName\u0027), \u0027-Queue Storage Message Count\u0027)]",
                      "location": "global",
                      "tags": {
                        "Monitoring Objective": "Capacity and Performance",
                        "related_package": "Alerts-Ops:GlobalMonitoring-True"
                      },
                      "properties": {
                        "severity": 3,
                        "enabled": true,
                        "evaluationFrequency": "PT5M",
                        "windowSize": "PT1H",
                        "criteria": {
                          "allOf": [
                            {
                              "threshold": 1000,
                              "name": "Metric1",
                              "metricNamespace": "Microsoft.Storage/storageAccounts/queueservices",
                              "metricName": "QueueMessageCount",
                              "operator": "GreaterThan",
                              "timeAggregation": "Average",
                              "skipMetricValidation": false,
                              "criterionType": "StaticThresholdCriterion"
                            }
                          ],
                          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria"
                        },
                        "autoMitigate": true,
                        "targetResourceType": "Microsoft.Storage/storageAccounts/queueservices",
                        "// targetResourceRegion": "canadacentral",
                        "scopes": [
                          "[parameters(\u0027resourceId\u0027)]"
                        ],
                        "actions": [
                          {
                            "actionGroupId": "[parameters(\u0027actionGroupId\u0027)]"
                          }
                        ]
                      }
                    }
                  ]
                },
                "mode": "Incremental",
                "parameters": {
                  "actionGroupId": {
                    "value": "[parameters(\u0027actionGroupId\u0027)]"
                  },
                  "resourceName": {
                    "value": "[field(\u0027name\u0027)]"
                  },
                  "resourceId": {
                    "value": "[field(\u0027id\u0027)]"
                  }
                }
              }
            }
          }
        }
      },
      "mode": "Indexed"
    }
  }
]
